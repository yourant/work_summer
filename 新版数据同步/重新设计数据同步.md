# 同步机制整体优化

**缺陷**

1. 在数据同步权限认证时，走了的单点登录逻辑，  但是其实只需要获取access_token即可

2. 记录日志混乱不方便定位问题

3. 对于删除操作（高危操作），过滤条件不明确（会出现误删的场景）

4. 同步失败报错场景分析不全面，失败后没有兼容机制

5. 数据同步要点，如何获取到需要新增，或同步，或删除的数据？

现给出以下方案
支持客户自定义需要同步的人员，或组织，支持自定义过滤条件
但是需要我们给出基础过滤条件， 什么样的人员算是新增的？

人员新增如何过滤
通过对人员进行分析可以得出结论
目前平台上存在的人员种类，可以从大的层面来分为 在职人员和离职人员
可以确定的是，离职人员不需要同步，另外还可以通过

过滤条件如下
1. 在职人员
2. 用户没有与第三方进行集成，也就是没有对应第三方的id
3. 其他过滤条件支持用户自定义，例如在职类型

什么样的用户算是需要同步的？



```
1. 新增的数据，通过


```


**重构要点**
1. 减少数据同步认证步骤，不走登录逻辑，单独获取access_token

2. 重写日志记录，找到同步痛点，针对性记录

3. 找业务部门协调，定位人员删除判定条件

4. 对每一次同步失败场景做分析，对可控场景做保底机制，其他场景记录报错日志


## 目前钉钉同步存在的问题

1. 钉钉手机号不允许修改，（解决方案，二选一方案1好点）
    1. 先删除再新建
    2. 直接报错记录日志

2. 部门不存在时人员同步（修改）会失败， （解决方案，二选一，我认为方案2好点）
    1. 保证定时任务执行顺序先部门，然后同步人员
    2. 对部门同步失败特殊处理， 同步失败时给同步到默认部门，也就是公司级之下

3. userid在公司中已经存在会报错（解决 方案， 二选一，我认为方案一好点）
    1. 生成一个随机码作为userid，再次绑定
    2. 不予解决做出日志提示

4. 其他报错
    记录报错日志


# 自定义同步

```
1. 打开实时同步系统开关， 企业设置-》 服务器设置-》-实时同步
2. 设置好自定义的同步类型，可以后端直接改同步类型文件，
3. 自定义配置云函数
    1. 命名需要配置
    2. third_type 配置
```





